<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"><HTML>  <HEAD><LINK rel="canonical" href="http://blog.barijaona.com/macintosh/osxpb4.html">    <META name="generator" content="HTML Tidy, see www.w3.org">    <META http-equiv="content-type" content=    "text/html;charset=iso-8859-1">    <META name="generator" content="GoLive CyberStudio 3">    <TITLE>MacOS X Public Beta : configuration du firewall</TITLE>    <META name="DESCRIPTION" content=    "Configuration d'ipfw sous MacOS X">    <META name="keywords" content=    "macintosh, osx, firewall, ipfw, nat, translation d'adresses">    <META http-equiv="lang" content="fr">    <LINK href="../style/barijaona.css" rel="styleSheet" type=    "text/css">  </HEAD>  <BODY bgcolor="white">    <!--#geoguide-->    <TABLE border="0" cellspacing="0" width="100%" frame="void"    rules="cols" summary="Menus">      <COLGROUP>        <COL span="6" width="1*">      </COLGROUP>      <TR align="center">        <TD bgcolor="#ffcccc"><A href="../" class="menu"        title="Les &eacute;ditoriaux">Accueil</A></TD>        <TD bgcolor="#ccffcc"><A href="../humour/" title=        "Et vous trouvez &ccedil;a dr&ocirc;le ?" class="menu">        Humour</A></TD>        <TD bgcolor="#ccccff"><A href="../macintosh/" title=        "Mac Pride" class="menu">Macintosh</A></TD>        <TD bgcolor="#ffffcc"><A href="../print66/" title=        "A free printer daemon for the Macintosh" class="menu">        Print66</A></TD>        <TD bgcolor="#ffccff"><A href="../best_of/" title=        "Sites Web, photos..." class="menu">        S&eacute;lection</A></TD>        <TD bgcolor="#ccffff"><A href="../equipe/" title=        "Qui &eacute;crit ce machin ?" class="menu">        &Eacute;diteur</A></TD>      </TR>      <TR bgcolor="#ccccff">        <TD colspan="6" align="left">&nbsp;&nbsp;<A href=        "index.html" class="submenu">MacOS X</A>&nbsp;|&nbsp;<A        href="os8et9.html" class="submenu">MacOS        classique</A>&nbsp;|&nbsp;<A href="macrules.html" class=        "submenu">Pourquoi ?</A></TD>      </TR>    </TABLE>    <TABLE width="100%" bgcolor="white" border="0" cellspacing="0"    cellpadding="15" frame="void" rules="cols" summary="contenu">      <COLGROUP>        <COL span="1" width="1*">      </COLGROUP>      <TR>        <TD align="right"><SPAN class="scrollmenu">Cet        &eacute;l&eacute;ment comporte 5 parties :</SPAN> &nbsp;<A        href="index.html" class="scrollmenu">        Intro</A>&nbsp;|&nbsp;<A href="osxpb1.html" class=        "scrollmenu">1</A>&nbsp;|<A href="osxpb2.html" class=        "scrollmenu">2</A>&nbsp;|&nbsp;<A href="osxpb3.html" class=        "scrollmenu">3</A>&nbsp;|&nbsp;<SPAN class="scrollmenu">        4</SPAN>&nbsp;|&nbsp;<A href="osxpb3.html" class=        "scrollmenu">&lt;&lt; Pr&eacute;c</A>&nbsp;|&nbsp;<SPAN        class="scrollmenu">Suiv &gt;&gt;</SPAN></TD>      </TR>      <TR>        <TD>          <H2>Une sophistication utile : configuration d'un          firewall sous MacOS X Public Beta</H2>          <P>Besoin d'&ecirc;tre convaincu que l'alliance d'Unix et          de MacOS nous permettra de regarder de haut Windows 2000          et Whistler ? Voici un exemple simple qui illustre          comment une administration pointue peut-&ecirc;tre mise          en place sous MacOS X Public Beta, sans investir dans un          truc comme Firewall One (pour mes confr&egrave;res          Macintoshiens, je les prie de voir le shareware          IPNetRouter et de penser &agrave; quelque chose de dix          fois plus compliqu&eacute;...)</P>          <P><VAR>ipfw</VAR> est une commande de firewall          int&eacute;gr&eacute;e dans les fondations de MacOSX...          Pour en savoir plus, vous pouvez taper la commande <KBD>          man ipfw</KBD></P>          <P>Comme ce n'est pas forc&eacute;ment tr&egrave;s clair,          voici ma configuration qui sans doute est tr&egrave;s          proche des besoins de pas mal de monde. J'ai plusieurs          micro-ordinateurs connect&eacute;s entre eux par          Ethernet. Une machine sous MacOS X joue le r&ocirc;le de          passerelle Internet, en se connectant au r&eacute;seau          des r&eacute;seaux par modem, gr&acirc;ce &agrave;          l'application <VAR>PPP Connect</VAR> fournie par          Apple.</P>          <P>Cette machine passerelle sous MacOS X qui joue le          r&ocirc;le de passerelle assure le partage de la seule          adresse IP publique fournie par le fournisseur          d'acc&egrave;s gr&acirc;ce au protocole NAT (Network          Address Translation). Pour &eacute;viter des conflits          entre les adresses IP de vos propres machines et celles          sur Internet, vous devrez configurer votre r&eacute;seau          sous Ethernet pour utiliser des adresses          r&eacute;serv&eacute;es aux r&eacute;seaux priv&eacute;s,          du type 10.x.x.x, 172.16.x.x &agrave; 172.31.x.x ou          192.168.0.x &agrave; 192.168.255.x (voir la RFC1918).</P>          <P>Pour configurer le firewall et le NAT, vous aurez          &agrave; vous connecter avec le profil utilisateur <VAR>          root</VAR> (<KBD>su root</KBD>). Le mieux est ensuite de          cr&eacute;er un script comme le mien, que j'ai          appel&eacute; <VAR>Firewall</VAR>, et de l'adapter          &agrave; vos besoins particuliers.</P>          <TABLE border="1" cellpadding="0" frame="" width="95%"          align="center" summary=          "Exemple de script de configuration du Firewall et de NAT">            <CAPTION align="bottom">              Exemple de script de configuration du Firewall et de              NAT            </CAPTION>            <COLGROUP>              <COL span="1" width="1*">            </COLGROUP>            <TR>              <TD>                <CODE>#!/bin/sh<BR>                <BR>                 #<BR>                 # Script de boot du Firewall<BR>                 #<BR>                <BR>                 # rattache NAT a l'interface PPP<BR>                 # rattachement dynamique car l'adresse n'est                determinee<BR>                 # qu'a la connexion pour la plupart des                providers<BR>                 /usr/sbin/natd -dynamic -interface ppp0<BR>                <BR>                 # Forcer la purge des regles courantes avant                rechargement<BR>                 /sbin/ipfw -f flush<BR>                <BR>                 # Diversion des paquets recus via l'interface PPP                NAT<BR>                 /sbin/ipfw -f add 800 divert natd all from any to                any via ppp0<BR>                <BR>                 # Tout permettre sur la boucle locale                (127.0.0.1)<BR>                 /sbin/ipfw -f add 1000 allow ip from any to any                via lo0<BR>                <BR>                 # Tout permettre sur Ethernet<BR>                 /sbin/ipfw -f add 1001 allow ip from any to any                via en0<BR>                <BR>                 # Autoriser les connections TCP que j'initialise                sur le port PPP<BR>                 /sbin/ipfw -f add 1005 allow tcp from any to any                out xmit ppp0 setup<BR>                <BR>                 # Autoriser la suite d'une connection TCP deja                etablie sur PPP<BR>                 /sbin/ipfw -f add 1008 allow tcp from any to any                via ppp0 established<BR>                 #### /sbin/ipfw -f add 1009 allow all from any to                any frag<BR>                <BR>                 # Autoriser ICMP (ping et traceroute)<BR>                 /sbin/ipfw -f add 2500 allow icmp from any to                any<BR>                <BR>                 # Autoriser les requetes DNS sur PPP<BR>                 /sbin/ipfw -f add 2504 allow udp from any to any                53 out xmit ppp0<BR>                 /sbin/ipfw -f add 2505 allow udp from any 53 to                any in recv ppp0<BR>                <BR>                 # Autoriser les requetes DHCP/BOOTP sur PPP<BR>                 /sbin/ipfw -f add 2508 allow udp from any to any                67-68 out xmit ppp0<BR>                 /sbin/ipfw -f add 2509 allow udp from any 67-68 to                any in recv ppp0<BR>                <BR>                 # Autoriser la synchronisation d'horloge NTP sur                PPP<BR>                 /sbin/ipfw -f add 2512 allow udp from any to any                123 out xmit ppp0<BR>                 /sbin/ipfw -f add 2513 allow udp from any 123 to                any in recv ppp0<BR>                <BR>                 # Autoriser iVisit (vid&eacute;oconf&eacute;rence)                sur PPP<BR>                 /sbin/ipfw -f add 2516 allow udp from any to any                9943 out xmit ppp0<BR>                 /sbin/ipfw -f add 2517 allow udp from any 9943 to                any in recv ppp0<BR>                 /sbin/ipfw -f add 2520 allow udp from any to any                56768 out xmit ppp0<BR>                 /sbin/ipfw -f add 2521 allow udp from any 56768 to                any in recv ppp0<BR>                 /sbin/ipfw -f add 2524 allow udp from any to any                9945 out xmit ppp0<BR>                 /sbin/ipfw -f add 2525 allow udp from any 9945 to                any in recv ppp0<BR>                <BR>                 #################################################<BR>                 # Services entrants standards * * *<BR>                 #################################################<BR>                <BR>                 # Permettre le serveur Web<BR>                 /sbin/ipfw -f add 4002 allow tcp from any to any                80 setup<BR>                <BR>                 # Permettre le FTP<BR>                 /sbin/ipfw -f add 4003 allow tcp from any to any                20-21 setup<BR>                <BR>                 # Refuser tout le reste<BR>                 /sbin/ipfw -f add 60001 deny ip from any to                any<BR>                </CODE>                 <P>&nbsp;</P>              </TD>            </TR>          </TABLE>          <BR>          <BR>                     <P>En tant que root, vous pouvez modifier ce script comme          vous l'entendez et le relancer autant de fois que          n&eacute;cessaire pour arriver &agrave; la configuration          qui vous plait.</P>          <P>Je pense que ce script est assez document&eacute; pour          ne pas n&eacute;cessiter de longs commentaires          suppl&eacute;mentaires... Notez juste que les          r&egrave;gles ont &eacute;t&eacute; class&eacute;es par          ordre de priorit&eacute; pour faciliter la lecture, et          que j'ai pris soin de mettre une r&egrave;gle (60001)          pour refuser tout ce qui n'est pas explicitement          autoris&eacute;.</P>          <P>Notez &eacute;galement que la r&egrave;gle 1005          suppose que vous et toutes les personnes qui utilisent          vos ordinateurs savez ce que vous faites lorsque vous          installez un programme... Cette r&egrave;gle dit que          toutes les demandes de connexions TCP venant de          l'int&eacute;rieur de votre r&eacute;seau sont          autoris&eacute;es. Si vous installez sans          r&eacute;fl&eacute;chir tout ce qui arrive via le Net,          bonjour les d&eacute;g&acirc;ts potentiels... Un pirate          peut par exemple berner un utilisateur chez vous et          l'amener &agrave; installer un programme qui du point de          vue du firewall semblera se comporter comme un navigateur          Web, mais qui en fait viendra se connecter chez le pirate          et lui permettra ensuite de prendre le contr&ocirc;le de          l'ensemble de votre r&eacute;seau... Vous comprenez mieux          pourquoi dans MacOS X n'importe qui ne peut pas installer          une application ?</P>          <P>Pour l'instant vous &ecirc;tes root, et avant          d'approfondir ces pr&eacute;occupations, il vous reste          &agrave; faire en sorte que votre beau script de firewall          soit lanc&eacute; automatiquement au d&eacute;marrage de          votre machine.</P>          <P>Cr&eacute;ez s'il n'existe pas encore le          r&eacute;pertoire <VAR>          /Library/StartUpItems/Firewall</VAR> et installez-y :</P>          <P>- votre script Firewall (que vous prot&egrave;gerez          avec les droits syst&egrave;mes ad&eacute;quats par la          commande <KBD>chmod 754 Firewall</KBD>)</P>          <P>- un fichier de param&egrave;tre <VAR>          StartupParameters.plist</VAR> qui contiendra :</P>          <TABLE border="1" cellpadding="0" frame="" width="95%"          align="center" summary=          "contenu du fichier /Library/StartUpItems/Firewall/Firewall">            <CAPTION align="bottom">              contenu du fichier <VAR>              /Library/StartUpItems/Firewall/Firewall</VAR>            </CAPTION>            <COLGROUP>              <COL span="1" width="1*">            </COLGROUP>            <TR>              <TD><CODE>{<BR>              Description = "firewall";<BR>               Provides = ("Firewall");<BR>               Requires = ("Network");<BR>               OrderPreference = "None";<BR>               Messages =<BR>               &nbsp;&nbsp;{<BR>               &nbsp;&nbsp;start = "Starting NAT/firewall";<BR>               &nbsp;&nbsp;stop = "Stopping NAT/firewall";<BR>               &nbsp;&nbsp;};<BR>               }</CODE></TD>            </TR>          </TABLE>          <P>C'est du XML... mais je pense que c'est assez clair          pour un anglophone.</P>          <P><VAR>StartupParameters.plist</VAR> sera          prot&eacute;g&eacute; avec la commande <KBD>chmod 644          StartupParameters.plist</KBD></P>        </TD>      </TR>      <TR>        <TD align="right"><SPAN class="scrollmenu">Cet        &eacute;l&eacute;ment comporte 5 parties :</SPAN> &nbsp;<A        href="index.html" class="scrollmenu">        Intro</A>&nbsp;|&nbsp;<A href="osxpb1.html" class=        "scrollmenu">1</A>&nbsp;|<A href="osxpb2.html" class=        "scrollmenu">2</A>&nbsp;|&nbsp;<A href="osxpb3.html" class=        "scrollmenu">3</A>&nbsp;|&nbsp;<SPAN class="scrollmenu">        4</SPAN>&nbsp;|&nbsp;<A href="osxpb3.html" class=        "scrollmenu">&lt;&lt; Pr&eacute;c</A>&nbsp;|&nbsp;<SPAN        class="scrollmenu">Suiv &gt;&gt;</SPAN></TD>      </TR>    </TABLE>    <TABLE border="0" cellspacing="0" cellpadding="0" width="100%"    frame="void" rules="cols" summary="Sous-menu de navigation">      <TR bgcolor="#ccccff">        <TD colspan="6" align="left">&nbsp;&nbsp;<A href=        "index.html" class="submenu">MacOS X</A>&nbsp;|&nbsp;<A        href="os8et9.html" class="submenu">MacOS        classique</A>&nbsp;|&nbsp;<A href="macrules.html" class=        "submenu">Pourquoi ?</A></TD>      </TR>    </TABLE>  </BODY></HTML>
